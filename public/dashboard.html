<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My document</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script type="text/javascript" src="js/index.js"></script>
  </head>

  <body>
    <my-menu></my-menu>
    <div id="metricWrapper">
      <form id="getPublicList" class="statBox">
        <p class="quantityOfLists">View Public Lists</p>
        <p>Input the URL to view a public List</p>
        <input
          id="publicUrl"
          type="text"
          class="text-field"
          placeholder="List URL here"
          required
        />
        <div id="errormsg"></div>
        <button type="submit" class="button-green">View List</button>
      </form>
      <div id="container1" class="row"></div>
      <div id="container2" class="row"></div>
      <template id="metricBoxTmpl">
        <div class="statBox">
          <div class="textLeft">
            <div class="quantityOfLists">20 Lists</div>
            <div class="spec">Joe Jonas</div>
            <div class="info">created by you</div>
          </div>
          <img src="images/user_metric.svg" class="imageStats" />
        </div>
      </template>
    </div>
  </body>
  <script type="text/javascript" src="js/menuBar.js"></script>
  <script>
    redirectNotAuthUser("index.html");
    let getPublicList = document.getElementById("getPublicList");
    let container1 = document.getElementById("container1");
    let container2 = document.getElementById("container2");
    let user = JSON.parse(sessionStorage.getItem("logindata"));
    let userid = user.userid;
    let token = user.token;
    let errormsg = document.getElementById("errormsg");
    let sessionError = JSON.parse(sessionStorage.getItem("errordata"));
    if (sessionError) {
      errormsg.innerHTML = sessionError.msg;
    }

    getPublicList.addEventListener("submit", function(evt) {
      evt.preventDefault();
      console.log(document.querySelector("#publicUrl").value);
      redirectUser(document.querySelector("#publicUrl").value);
    });

    displayMetrics();

    async function displayMetrics() {
      let listData = await utilities.getListsByUserID(userid, token);
      let publicLists = listData.filter(obj => {
        return obj.public == 1;
      });
      let taskData = await utilities.getTasksByListIDS(listData, token);
      let finishedTasks = taskData.filter(obj => {
        return obj.finished == true;
      });
      let overdueTasks = taskData.filter(obj => {
        return obj.due_date < new Date().toISOString().split("T")[0];
      });

      generateMetricsBox(
        overdueTasks.length,
        "Overdue Tasks",
        "More information in Lists",
        "images/user_metric.svg",
        container1
      );

      generateMetricsBox(
        finishedTasks.length,
        "Finished Tasks",
        "In your Lists",
        "images/user_metric.svg",
        container1
      );

      generateMetricsBox(
        listData.length,
        "Lists",
        "Created by you",
        "images/user_metric.svg",
        container2
      );

      generateMetricsBox(
        publicLists.length,
        "Public Lists",
        "Shared by you",
        "images/user_metric.svg",
        container2
      );
    }

    async function generateMetricsBox(number, txt1, txt2, img, container) {
      let metricBoxTmpl = document.getElementById("metricBoxTmpl");
      metricBoxTmpl.content.querySelector(
        ".quantityOfLists"
      ).innerHTML = await number;
      metricBoxTmpl.content.querySelector(".spec").innerHTML = txt1;
      metricBoxTmpl.content.querySelector(".info").innerHTML = txt2;
      metricBoxTmpl.content.querySelector(".imageStats").src = img;
      metricBoxContent = metricBoxTmpl.content.cloneNode(true);
      container.appendChild(metricBoxContent);
    }
  </script>
</html>
