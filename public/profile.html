<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script type="text/javascript" src="js/index.js"></script>
  </head>

  <body>
    <my-menu></my-menu>
    <div id="container"></div>

    <template id="profile">
      <div class="wrapperprofile">
        <img src="images/profile.svg" id="profileimg" />
        <h2 id="name">Jonathan Doe</h2>
        <p id="email" class="profile-email">jonathandoe@gmail.com</p>
        <div class="buttoncol">
          <button id="edit" class="button-green">Edit Profile</button>
          <button id="changepw" class="button-green">Change Password</button>
        </div>
        <div class="buttoncol">
          <button id="logout" class="button-blue">Logout</button>
          <button id="deleteUser" class="button-blue">Delete user</button>
        </div>
      </div>
    </template>

    <template id="editProfile">
      <form class="wrapperprofile">
        <img src="images/profile.svg" id="profileimg" />
        <h1>Edit profile</h1>
        <div class="textwrap">
          <input
            type="text"
            id="firstname"
            placeholder="Firstname"
            class="text-field"
            required
          />
          <input
            type="text"
            id="lastname"
            placeholder="Lastname"
            class="text-field"
            required
          />
          <input
            type="email"
            id="email"
            placeholder="E-mail"
            class="text-field"
            required
          />
        </div>
        <div id="errormsg"></div>
        <div class="buttonrow">
          <button type="button" id="goback" class="button-blue">Go Back</button>
          <button type="submit" id="save" class="button-green">
            Save Changes
          </button>
        </div>
      </form>
    </template>

    <template id="changePw">
      <form class="wrapperprofile">
        <img src="images/profile.svg" id="profileimg" />
        <h1>Change password</h1>
        <div class="textwrap">
          <input
            type="password"
            id="newpw"
            placeholder="New Password"
            class="text-field"
          />
          <input
            type="password"
            id="newpwrepeat"
            placeholder="Repeat New Password"
            class="text-field"
          />
        </div>
        <div id="errormsg"></div>
        <div class="buttonrow">
          <button type="button" id="goback" class="button-blue">Go Back</button>
          <button type="submit" id="change" class="button-green">
            Change Password
          </button>
        </div>
      </form>
    </template>
  </body>

  <script type="text/javascript" src="js/menuBar.js"></script>
  <script>
    let container = document.getElementById("container");
    let profileTmpl = document.getElementById("profile");
    let editTmpl = document.getElementById("editProfile");
    let changePwTmpl = document.getElementById("changePw");

    let userid = JSON.parse(sessionStorage.getItem("logindata")).userid;
    let userFirstname;
    let userLastname;
    let userEmail;

    showUserInfo();

    async function showUserInfo() {
      let url = "http://localhost:3000/users/" + userid;

      let cfg = {
        method: "GET",
        headers: { "Content-Type": "application/json" }
      };

      try {
        let data = await utilities.requestToServer(url, cfg);

        if (data == null) {
          throw data;
        } else {
          userFirstname = data[0].firstname;
          userLastname = data[0].lastname;
          userEmail = data[0].email;
          profileTmpl.content.querySelector("#name").innerHTML =
            userFirstname + " " + userLastname;
          profileTmpl.content.querySelector("#email").innerHTML = userEmail;

          container.innerHTML = "";
          container.appendChild(profileTmpl.content.cloneNode(true));

          document
            .querySelector("#edit")
            .addEventListener("click", editProfilePage);
          document
            .querySelector("#changepw")
            .addEventListener("click", changePasswordPage);
          document
            .querySelector("#logout")
            .addEventListener("click", logoutUser);
          document
            .querySelector("#deleteUser")
            .addEventListener("click", deleteUser);
        }
      } catch (err) {
        console.log(err);
      }
    }

    function editProfilePage(evt) {
      container.innerHTML = "";
      container.appendChild(editTmpl.content.cloneNode(true));

      let firstname = document.querySelector("#firstname");
      firstname.value = userFirstname;
      let lastname = document.querySelector("#lastname");
      lastname.value = userLastname;
      let email = document.querySelector("#email");
      email.value = userEmail;

      document
        .querySelector("#goback")
        .addEventListener("click", function(evt) {
          showUserInfo();
        });

      document.querySelector("form").addEventListener("submit", function(evt) {
        evt.preventDefault();
        saveChanges(firstname, lastname, email);
      });
    }

    function changePasswordPage(evt) {
      evt.preventDefault();
      container.innerHTML = "";
      container.appendChild(changePwTmpl.content.cloneNode(true));

      let newpw = document.querySelector("#newpw");
      let newpwrepeat = document.querySelector("#newpwrepeat");

      document
        .querySelector("#goback")
        .addEventListener("click", function(evt) {
          showUserInfo();
        });

      document.querySelector("form").addEventListener("submit", function(evt) {
        evt.preventDefault();
        changePw(newpw, newpwrepeat);
      });
    }

    async function saveChanges(firstname, lastname, email) {
      if (
        utilities.checkNameInput(firstname, lastname) &&
        (await utilities.isNewOrOldEmail(email))
      ) {
        let url = "http://localhost:3000/users";

        let userData = {
          firstname: firstname.value,
          lastname: lastname.value,
          email: email.value,
          id: userid
        };

        let cfg = {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData)
        };

        try {
          let data = await utilities.requestToServer(url, cfg);

          let sessionData = JSON.parse(sessionStorage.getItem("logindata"));
          sessionData.email = email.value;
          sessionStorage.setItem("logindata", JSON.stringify(sessionData));
          showUserInfo();
        } catch (err) {
          console.log(err);
        }
      }
    }

    async function changePw(password, passwordrep) {
      if (utilities.checkPasswords(password, passwordrep)) {
        let url = "http://localhost:3000/users/changePassword";

        let userData = {
          password: password.value,
          id: userid
        };

        let cfg = {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(userData)
        };

        try {
          let data = await utilities.requestToServer(url, cfg);
          showUserInfo();
        } catch (err) {
          console.log(err);
        }
      }
    }

    function logoutUser() {
      sessionStorage.removeItem("logindata");
      redirectNotAuthUser("index.html");
    }

    async function deleteUser() {
      let url = "http://localhost:3000/users/" + userid;

      let cfg = {
        method: "DELETE",
        headers: { "Content-Type": "application/json" }
      };

      try {
        let data = await utilities.requestToServer(url, cfg);
        showUserInfo();
      } catch (err) {
        console.log(err);
      }

      sessionStorage.removeItem("logindata");
      redirectNotAuthUser("index.html");
    }
  </script>
</html>
