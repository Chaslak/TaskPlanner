<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My document</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script type="text/javascript" src="js/index.js"></script>
  </head>

  <body>
    <my-menu></my-menu>
    <div id="container"></div>
    <template id="showListsTmpl">
      <header>
        <p id="pageTitle">
          <img src="images/lists.svg" id="listimg" /><em class="green"
            >My&nbsp
          </em>
          Lists
        </p>
        <button id="addList" class="button-green">
          Add new list <img src="images/plus.svg" />
        </button>
      </header>
      <main id="show-lists-wrapper"></main>
    </template>
    <template id="newListTmpl">
      <header>
        <p id="pageTitle">
          <img src="images/new_edit_list.svg" /><em class="green">New&nbsp </em>
          List
        </p>
      </header>
      <form id="new-list-wrapper">
        <div>
          <p class="new-list-heading">List Title</p>
          <input
            type="text"
            id="new-list-title"
            placeholder="List title here"
            class="text-field-50"
            required
          />
        </div>
        <div>
          <p class="new-list-heading">List Sharing</p>
          <div class="radio-group">
            <p>
              <input
                type="radio"
                name="public"
                value="private"
                class="radio-buttons"
                checked
              />
              Private
            </p>
            <p class="pgrey">Your list is private. Only you can see it.</p>
          </div>
          <div class="radio-group">
            <p><input type="radio" name="public" value="public" /> Public</p>
            <p class="pgrey">
              Your list is public. Everyone who has the link can access it.
            </p>
          </div>
          <div class="radio-group">
            <p>
              <input type="radio" name="public" value="members" /> Add members
            </p>
            <p class="pgrey">
              Share this list with certain users to let them become Members of
              this list. You can then assign them to tasks on the list.
            </p>
            <div class="members-div">
              <div id="list-members">

              </div>
              <input
                type="text"
                id="member-email"
                placeholder="User email address"
                class="text-field-50"
              />
              <p id="errormsg-member"></p>
              <button type="button" class="add-button" id="addMember">
                <img src="images/plus_green_button.svg" /> Add Member
              </button>
            </div>
          </div>
        </div>
        <div id="tasks-container">
          <p class="new-list-heading">Tasks</p>
          <button type="button" id="addTask" class="add-button">
            <img src="images/plus_green_button.svg" />Add Task
          </button>
        </div>
        <div class="buttonrow">
          <button type="button" id="cancelList" class="button-blue">
            Cancel List</button
          ><button type="submit" id="saveList" class="button-green">
            Save List
          </button>
        </div>
      </form>
    </template>
    <template id="task-div">
      <div class="task-div">
        <div class="task-title-div">
          <input
            type="text"
            class="task-title text-field-50"
            placeholder="Task title here"
            required
          />
          <img src="images/delete_red_button.svg" class="delete-icon-red" />
        </div>
        <div class="taskrowmenu">
          <div class="dropdown-div">
            Assign deadline:
            <input type="date" class="due-date" name="date" />
          </div>
          <div class="dropdown-div">
            Add tag:
            <select id="tagDropdown" class="tag"> </select>
          </div>
          <div class="dropdown-div">
            Assign user:
            <select class="user">
              <option value="None" selected>No User</option>
            </select>
          </div>
        </div>
      </div>
    </template>
  </body>
  <script type="text/javascript" src="js/menuBar.js"></script>
  <script>
    redirectNotAuthUser("index.html");
    let container = document.getElementById("container");
    let detailID;
    let isNewList = true;
    let newListid;
    let existingTasks = true;
    let TagArr = utilities.getTagArray();

    showLists();

    async function showLists() {
      try {
        let showListTmpl = document.getElementById("showListsTmpl");
        let div = showListTmpl.content.cloneNode(true);
        container.appendChild(div);
        document
          .querySelector("#addList")
          .addEventListener("click", addNewList);
        let userData = JSON.parse(sessionStorage.getItem("logindata"));
        let listData = JSON.parse(localStorage.getItem("listdata"));
        let ids;

        if (listData == null || listData.length == 0) {
          let url = "http://localhost:3000/lists/all/" + userData.userid;
          listData = await utilities.requestToServer(url, {});
          localStorage.setItem("listdata", JSON.stringify(listData));
        }
        if (listData.length > 0) {
          let taskData = JSON.parse(localStorage.getItem("taskdata"));
          if (taskData == null || taskData.length == 0) {
            for (let i = 0; i < listData.length; i++) {
              if (i == 0) {
                ids = listData[i].id;
              } else {
                ids += "," + listData[i].id;
              }
            }

            let url2 =
              "http://localhost:3000/tasks/allTasksBySeveralIDS/" + ids;

            taskData = await utilities.requestToServer(url2, {});
            localStorage.setItem("taskdata", JSON.stringify(taskData));
          }

          for (let list of listData) {
            let listWrapper = document.createElement("div");
            listWrapper.setAttribute("id", list.id);
            listWrapper.classList.add("list-wrapper");

            let listViewList = document.createElement("div");
            listViewList.classList.add("viewList");

            let listDiv = document.createElement("div");
            listDiv.classList.add("list-div");
            listDiv.innerHTML = list.name;

            let deleteIcon = document.createElement("img");
            deleteIcon.setAttribute("src", "images/delete_blue.svg");
            deleteIcon.classList.add("delete-icon-blue");
            listDiv.appendChild(deleteIcon);

            listViewList.appendChild(listDiv);

            for (let [index, task] of taskData.entries()) {
              if (task.listid == list.id) {
                let taskDiv = document.createElement("div");
                taskDiv.classList.add("list-div");
                taskDiv.innerHTML = task.name;
                taskDiv.setAttribute("id", "index-" + index);

                let checkedDiv = document.createElement("div");
                if (task.finished) {
                  checkedDiv.classList.add("checked");
                } else {
                  checkedDiv.classList.add("unchecked");
                }
                taskDiv.appendChild(checkedDiv);

                listViewList.appendChild(taskDiv);
              }
            }

            listWrapper.appendChild(listViewList);

            let editButton = document.createElement("button");
            editButton.innerHTML = "Edit List";
            editButton.classList.add("edit");
            listWrapper.appendChild(editButton);

            document.querySelector("main").appendChild(listWrapper);

            //eventlistener for viewing a list
            document.querySelectorAll(".viewList").forEach(div => {
              div.addEventListener("click", viewList);
            });

            //eventlistener for editing a list
            document.querySelectorAll(".edit").forEach(div => {
              div.addEventListener("click", editList);
            });

            //eventlistener for deleting the respective list
            document.querySelectorAll(".delete-icon-blue").forEach(btn => {
              btn.addEventListener("click", deleteList);
            });
          }
        } else {
          console.log("no lists yet");
        }
      } catch (err) {
        console.log(err);
      }
    }

    async function viewList(evt) {
      detailID = evt.target.parentNode.parentNode.id;
      redirectUser("viewlist.html?id=" + detailID);
    }

    async function addNewList(evt) {
      let thisUser = JSON.parse(sessionStorage.getItem("logindata"));
      let listmembers = [{id: thisUser.userid, firstname: thisUser.firstname, lastname: thisUser.lastname, email: thisUser.email}]
      isNewList = true;
      let newListTmpl = document.getElementById("newListTmpl");
      let newListContent = newListTmpl.content.cloneNode(true);
      container.innerHTML = "";
      container.appendChild(newListContent);
      document.querySelector("#addMember").addEventListener("click", editMembers);
      document.querySelector("#addTask").addEventListener("click", addTaskForm);
      document.querySelector("form").addEventListener("submit", saveList);
      document
        .querySelector("#cancelList")
        .addEventListener("click", function() {
          redirectUser("showlists.html");
        });
    }

    async function editList(evt) {
      isNewList = false;
      existingTasks = true;
      detailID = evt.target.parentNode.id;
      let lists = JSON.parse(localStorage.getItem("listdata"));
      let tasks = JSON.parse(localStorage.getItem("taskdata"));
      sessionStorage.removeItem('listMembers');
      sessionStorage.removeItem('newMembers');
      sessionStorage.removeItem('deletedMembers');
      let listData = lists.find(obj => {
        return obj.id == detailID;
      });
      let newListTmpl = document.getElementById("newListTmpl");
      newListTmpl.content.querySelector(".green").innerHTML = "Edit&nbsp";
      newListTmpl.content.querySelector("#new-list-title").value =
        listData.name;
      let public = listData.public == true ? "public" : "private";
      newListTmpl.content.querySelector(
        "input[value=" + public + "]"
      ).checked = true;

      let newListContent = newListTmpl.content.cloneNode(true);
      container.innerHTML = "";
      container.appendChild(newListContent);

      let tasksData = tasks.filter(obj => {
        return obj.listid == detailID;
      });

      const addOptions = await addMemberData(detailID)
      let existing = JSON.parse(sessionStorage.getItem('listMembers'));
      createMemberDiv(existing);
      

      for (let [index, task] of tasksData.entries()) {
        addTaskForm(task);

        let taskDiv = document.querySelectorAll(".task-div")[index];

        taskDiv.querySelector(".task-title").value = task.name;
        let date = task.due_date ? task.due_date.split("T")[0] : "";
        taskDiv.querySelector(".due-date").value = date;
        let tag = task.tag ? task.tag : "None";
        taskDiv.querySelector(".tag").value = tag;
        
        taskDiv.setAttribute("id", "taskid-" + task.id);
      }
      
        /*const addOptions = await addMemberData(detailID)
        console.log(addOptions)
        if(addOption){
        let existing = sessionStorage.getItem('listMembers');
        existing = JSON.parse(existing)
        addOption(existing)
        console.log(existing)
      }*/
     
      //addMemberData(detailID)
      /*const getMemberData = () => {
        const result = addMemberData(detailID);
        
        return result
      }
      
      addOption(getMemberData)*/
    
      document.querySelectorAll(".delete-icon-red").forEach(btn => {
        btn.addEventListener("click", deleteTaskButton);
      });
      
      document.querySelector("#addMember").addEventListener("click", editMembers);
      document.querySelector("#addTask").addEventListener("click", addTaskForm);
      document.querySelector("form").addEventListener("submit", saveChanges);
      document
        .querySelector("#cancelList")
        .addEventListener("click", function() {
          redirectUser("showlists.html");
        });

      existingTasks = false;
    }

    async function deleteList(evt) {
      evt.stopPropagation();
      let id = evt.target.parentNode.parentNode.parentNode.id;
      if (
        confirm(
          "Are you sure you want to delete the list " +
            evt.target.parentNode.innerText +
            "?"
        )
      ) {
        let url = "http://localhost:3000/lists/ " + id;

        let cfg = {
          method: "DELETE",
          headers: { "Content-Type": "application/json" }
        };

        try {
          let data = await utilities.requestToServer(url, cfg);
          localStorage.removeItem("taskdata");
          localStorage.removeItem("listdata");
          redirectUser("showlists.html");
        } catch (err) {
          console.log(err);
        }
      }
    }

    function addTaskForm() {
      let newTaskDiv = document.getElementById("task-div");
      if (!isNewList && !existingTasks) {
        let div = newTaskDiv.content
          .querySelector(".task-div")
          .classList.add("added");
      }
      console.log(newTaskDiv.content.querySelector(".user"));
      addOption(JSON.parse(sessionStorage.getItem('listMembers')),newTaskDiv.content);
     

      let tagDropdown = newTaskDiv.content.querySelector("#tagDropdown");
      TagArr.forEach(obj => {
        tagDropdown.appendChild(new Option(obj.text, obj.value));
      });

      let newTaskContent = newTaskDiv.content.cloneNode(true);
      let tasksContainer = document.querySelector("#tasks-container");
      tasksContainer.appendChild(newTaskContent);

      document
        .querySelectorAll(".added .delete-icon-red:last-child")
        .forEach(btn => {
          btn.addEventListener("click", deleteTaskButton);
        });
    }
    async function editMembers(){
      let memberEmail = document.getElementById("member-email")
      let existingUser = await checkEmail()
      async function checkEmail(){
        console.log(memberEmail.value)
      let url = "http://localhost:3000/users/emailAndData/" + memberEmail.value;
        let cfg = {
          method: "GET",
          headers: { "Content-Type": "application/json" }
        };
        try {
          let data = await utilities.requestToServer(url, cfg);
          return data
        } catch (err) {
          console.log(err);
        }
      }
      console.log(existingUser)
      if(existingUser){
        let existing = sessionStorage.getItem('listMembers');
        existing = existing ? JSON.parse(existing) : [];

        let membersAdd = sessionStorage.getItem('newMembers');
        membersAdd = membersAdd ? JSON.parse(membersAdd) : [];
        console.log(existing)

        let index = existing.findIndex(member => member.email==memberEmail.value)
        if (index === -1){
            existing.push(existingUser);
            membersAdd.push(existingUser);
            sessionStorage.setItem('listMembers', JSON.stringify( existing));
            sessionStorage.setItem('newMembers', JSON.stringify( membersAdd));
            console.log(existingUser);
            addOption([existingUser]);
            createMemberDiv([existingUser]); 
        }
        else{
          console.log("The person is allerdy a member of this list.")
        }
      }
      else{
        console.log("No user with that email exists")
      }
    }

    async function addMemberData(listID){
      let url = "http://localhost:3000/lists/member/"+listID;

      let cfg = {
        method: "GET",
        headers: { "Content-Type": "application/json" },
      };

      try {
        let resp = await fetch(url, cfg);
        let data = await resp.json();
        let existing = sessionStorage.getItem('listMembers');
        // If no existing data, create an array
        existing = existing ? JSON.parse(existing) : [];
        data.forEach(index => {
        existing.push(index)
        })
        sessionStorage.setItem('listMembers', JSON.stringify( existing));
        console.log(data)
        return data
      } catch (err) {
        console.log(err);
      }
    }

    function addOption(array, element = document){
      array.forEach(member => {
        let user = element.querySelector(".user");
        let option = document.createElement("option");
        option.text = member.firstname+" "+member.lastname+" ("+member.email+")";
        option.value = member.id;
        user.appendChild(option);
        console.log(member)
       });
    }

    function createMemberDiv(array){
      let list_members = document.getElementById("list-members");
      array.forEach(member => {
      let wrapper = document.createElement("div");
      wrapper.id = member.id;
      let membername = document.createElement("p");
      membername.innerHTML = member.firstname +" "+ member.lastname;
      let img = document.createElement('img');
      img.src = "images/delete_red_button.svg"
      img.addEventListener('click', removeMember);
      wrapper.appendChild(membername);
      wrapper.appendChild(img);
      list_members.appendChild(wrapper);
      })
    }

    function removeMember(evt) {
                    
      let elm = evt.currentTarget;
      document.querySelectorAll(".user").forEach(opt => {
        for (var i=0; i<opt.length; i++) {
          if (opt.options[i].value == elm.parentNode.id){
          opt.remove(i);
          }
        } 
      });
      elm.parentNode.parentNode.removeChild(elm.parentNode);
      let existing = JSON.parse(sessionStorage.getItem('listMembers'));
      let membersAdd = JSON.parse(sessionStorage.getItem('newMembers'));
      let deleted = sessionStorage.getItem('deletedMembers');
      deleted = deleted ? JSON.parse(deleted) : [];
      let index_existing = existing.findIndex(member => member.id==elm.parentNode.id)
      let index_membersAdd = membersAdd.findIndex(member => member.id==elm.parentNode.id)
      if (index_existing > -1) {
        let del = existing.splice(index_existing, 1);
        if(index_membersAdd==-1){
          deleted.push(del[0]);
          console.log('deleted')
        }
        existing.splice(index_existing, 1);
      }
      if (index_membersAdd > -1) {
        membersAdd.splice(index_membersAdd, 1);
      }
      console.log(existing)
      sessionStorage.setItem('deletedMembers', JSON.stringify( deleted));
      sessionStorage.setItem('listMembers', JSON.stringify( existing));
      sessionStorage.setItem('newMembers', JSON.stringify( membersAdd));
      console.log( JSON.parse(sessionStorage.getItem('deletedMembers')) )
    }



    async function saveList(evt) {
      evt.preventDefault();
      newListid = detailID;
      let taskDivs = document.querySelectorAll(".task-div:not(.added)");

      if (document.querySelectorAll(".task-div") < 1) {
        console.log("make sure to add tasks to your list");
        return;
      }

      let radio = document.querySelector("input[name=public]:checked").value;
      let userid = JSON.parse(sessionStorage.getItem("logindata")).userid;
      let public = 0;

      if (radio == "public") {
        public = 1;
      }

      let listData;
      let url;
      let cfg;

      listData = {
        name: document.querySelector("#new-list-title").value,
        owner: userid,
        public: public
      };
      url = "http://localhost:3000/lists";
      cfg = {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(listData)
      };

      try {
        let newlistData = await utilities.requestToServer(url, cfg);
        newListid = newlistData.id;
      } catch (err) {
        console.log(err);
      }
      
      


      url = "http://localhost:3000/lists/member";
      cfg = {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(condensedMembers)
      };

      try {
        let newMemberData = await utilities.requestToServer(url, cfg);
        console.log(newMemberData);
      } catch (err) {
        console.log(err);
      }

      //save tasks
      let newTasks = getAllTaskData(taskDivs);
      url = "http://localhost:3000/tasks/createSeveralTasks";
      cfg = {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(newTasks)
      };

      try {
        let newTaskData = await utilities.requestToServer(url, cfg);
        console.log(newTaskData);
      } catch (err) {
        console.log(err);
      }

      localStorage.removeItem("taskdata");
      localStorage.removeItem("listdata");
      redirectUser("showlists.html");
    }

    async function saveChanges(evt) {
      evt.preventDefault();
      newListid = detailID;
      let taskDivs = document.querySelectorAll(".task-div:not(.added)");
      if (document.querySelectorAll(".task-div") < 1) {
        console.log("make sure to add tasks to your list");
        return;
      }
      let radio = document.querySelector("input[name=public]:checked").value;
      let userid = JSON.parse(sessionStorage.getItem("logindata")).userid;
      let public = 0;
      if (radio == "public") {
        public = 1;
      }

      let listData;
      let url;
      let cfg;

      listData = {
        name: document.querySelector("#new-list-title").value,
        public: public,
        id: detailID
      };
      url = "http://localhost:3000/lists";
      cfg = {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(listData)
      };

      try {
        let newlistData = await utilities.requestToServer(url, cfg);
        newListid = newlistData.id;
      } catch (err) {
        console.log(err);
      }


      //save members
      let condensedMembers = [];
      let membersAdd = JSON.parse(sessionStorage.getItem('newMembers'));
      membersAdd.forEach(member => {
        condensedMembers.push(parseInt(detailID));
        condensedMembers.push(member.id);
      })
      console.log(condensedMembers)

      //save tasks
      let newTasks = getAllTaskData(taskDivs);

      console.log(newTasks);
      for (let [index, task] of newTasks.entries()) {
        console.log(newTasks[index]);
        url = "http://localhost:3000/tasks";
        cfg = {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(newTasks[index])
        };

        try {
          let newTaskData = await utilities.requestToServer(url, cfg);
          console.log(newTaskData);
        } catch (err) {
          console.log(err);
        }
      }

      //newly added tasks to already existing list
      let addedTaskDivs = document.querySelectorAll(".added");
      console.log(addedTaskDivs);
      if (addedTaskDivs.length != 0) {
        console.log("existing");
        isNewList = true;
        console.log(detailID);
        newListid = detailID;
        let addedTasks = getAllTaskData(addedTaskDivs);
        isNewList = false;
        console.log(addedTasks);

        url2 = "http://localhost:3000/tasks/createSeveralTasks";
        cfg2 = {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(addedTasks)
        };

        try {
          let newTaskData = await utilities.requestToServer(url2, cfg2);
        } catch (err) {
          console.log(err);
        }
      }

      localStorage.removeItem("taskdata");
      localStorage.removeItem("listdata");
      //redirectUser("showlists.html");
    }

    async function deleteTaskButton(evt) {
      console.log("in delete");
      let element = evt.target.parentNode.parentNode;

      if (!isNewList && !element.classList.contains("added")) {
        let taskid = element.id.split("-")[1];
        let url = "http://localhost:3000/tasks/" + taskid;
        let cfg = {
          method: "DELETE",
          headers: { "Content-Type": "application/json" }
        };
        let tasks = JSON.parse(localStorage.getItem("taskdata"));

        newtasks = tasks.filter(function(obj) {
          return obj.id != taskid;
        });

        localStorage.setItem("taskdata", JSON.stringify(newtasks));

        try {
          let deletedData = await utilities.requestToServer(url, cfg);
        } catch (err) {
          console.log(err);
        }
      }

      element.remove();
    }
    async function getMemberData (listID){
      let url = "http://localhost:3000/lists/member/"+listID;

      let cfg = {
        method: "GET",
        headers: { "Content-Type": "application/json" },
      };

      try {
        var resp = await fetch(url, cfg);
        var data = await resp.json();
        return data;
      } catch (err) {
        console.log(err);
      }
    }
    function getAllTaskData(taskDivs) {
      let newTasks = [];
      for (let task of taskDivs) {
        let title = task.querySelector(".task-title").value;
        console.log(task.querySelector(".due-date").value);
        let date =
          task.querySelector(".due-date").value == ""
            ? null
            : task.querySelector(".due-date").value;
        let tag =
          task.querySelector(".tag").value == "None"
            ? null
            : task.querySelector(".tag").value;
        let user = 
          task.querySelector(".user").value == "None"
            ? null
            : task.querySelector(".user").value;

        let taskid = task.id.split("-")[1];

        console.log(newListid);

        if (isNewList) {
          newTasks.push(title, date, tag, user, 0, newListid);
        } else {
          newTasks.push({
            name: title,
            date: date,
            tag: tag,
            user: user,
            taskid: taskid
          });
        }
      }
      return newTasks;
    }
  </script>
</html>
