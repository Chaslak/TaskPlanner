<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My list</title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script type="text/javascript" src="js/index.js"></script>
  </head>

  <body>
    <my-menu></my-menu>
    <div id="container"></div>
    <template id="viewListTmpl">
      <div class="wrapperviewlist">
        <div id="listTitleWrapper">
          <img
            src="images/backbutton_white.svg"
            id="backButton"
            class="viewListIcon"
          />
          <div id="viewListTitle">List Nr.1</div>
          <img
            src="images/pencil-edit-button.svg"
            class="viewListIcon no-visibility"
          />
        </div>

        <div class="filterBar">
          <div class="filter-dropdown">
            <div class="row">
              <input type="radio" name="filter" value="tag" checked />
              <p class="tag-filter">Filter by Tags:</p>
            </div>
            <select id="tagDropdown"> </select>
          </div>
          <div class="filter-dropdown">
            <div class="row">
              <input type="radio" name="filter" value="date" />
              <p class="date-filter">Filter by Due Date:</p>
            </div>
            <select id="dateDropdown"> </select>
          </div>
        </div>

        <div id="taskBoxes"></div>
      </div>
    </template>

    <template id="taskBoxTmpl">
      <div class="viewList-task">
        <div class="row">
          <input
            type="radio"
            class="radioFinished"
            name="taskid"
            value="date"
          />
          <div class="vl-task-title">Task Nr.1</div>
        </div>
        <div class="row attributes">
          <div class="row attr">
            <img src="images/icon_clock.svg" />
            <div class="duedate">Due: 26.10.2019</div>
          </div>
          <div class="row attr">
            <img src="images/icon_user.svg" />
            <div class="user">John Doe</div>
          </div>
          <div class="row attr">
            <img src="images/icon_tag.svg" />
            <div class="tag">Important</div>
          </div>
        </div>
      </div>
    </template>
  </body>
  <script type="text/javascript" src="js/menuBar.js"></script>
  <script>
    console.log("here");
    if (!isLoggedIn()) {
      console.log(isLoggedIn());
      sessionStorage.setItem(
        "errordata",
        JSON.stringify({
          msg: "You have to be logged in to view a public list."
        })
      );
      //redirectNotAuthUser("index.html");
    }

    let tagArr = utilities.getTagArray();
    let dateArr = utilities.getDateArray();

    let urlParams = new URLSearchParams(window.location.search);
    let user = JSON.parse(sessionStorage.getItem("logindata"));
    let userid = user.userid;
    let token = user.token;
    let list;
    let tasks;
    let listid = urlParams.get("id");
    let container = document.getElementById("container");

    displayList();

    async function displayList() {
      let url = "http://localhost:3000/lists/view/" + listid;
      let cfg = {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          authorization: token
        }
      };
      try {
        list = await utilities.requestToServer(url, cfg);
      } catch (err) {
        utilities.handleError(err);
      }

      if (list.public == false && list.owner != userid) {
        sessionStorage.setItem(
          "errordata",
          JSON.stringify({
            msg: "You can only view public lists."
          })
        );
        redirectUser("dashboard.html");
      } else {
        let viewListTmpl = document.getElementById("viewListTmpl");
        viewListTmpl.content.querySelector("#viewListTitle").innerHTML =
          list.name;
        let tagDropdown = viewListTmpl.content.querySelector("#tagDropdown");
        tagArr.forEach(obj => {
          tagDropdown.appendChild(new Option(obj.text, obj.value));
        });

        let dateDropdown = viewListTmpl.content.querySelector("#dateDropdown");
        dateArr.forEach(obj => {
          dateDropdown.appendChild(new Option(obj.text, obj.value));
        });
        let viewListContent = viewListTmpl.content.cloneNode(true);
        container.appendChild(viewListContent);

        document
          .querySelector("#tagDropdown")
          .addEventListener("change", changeTagFilter);

        document
          .querySelector("#dateDropdown")
          .addEventListener("change", changeDateFilter);

        document.querySelectorAll("input[name=filter]").forEach(element => {
          element.addEventListener("click", activateFilter);
        });

        document.querySelector("#backButton").addEventListener("click", goBack);

        getTasks("None");
      }
    }

    async function getTasks(urlAddition) {
      try {
        let url =
          "http://localhost:3000/tasks/tasksByOneID/" +
          listid +
          "/" +
          urlAddition;

        let cfg = {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            authorization: token
          }
        };
        tasks = await utilities.requestToServer(url, cfg);
      } catch (err) {
        utilities.handleError(err);
      }

      let taskBoxes = document.querySelector("#taskBoxes");
      taskBoxes.innerHTML = "";

      if (tasks.length != 0) {
        for (let task of tasks) {
          let user = "No user assigned";
          if (task.assigned_user != null) {
            try {
              let data = await utilities.getUserByID(task.assigned_user, token);
              user = data[0].firstname + " " + data[0].lastname;
            } catch (err) {
              utilities.handleError(err);
            }
          }
          displayListTask(task, user);
        }
      } else {
        let message = document.createElement("p");
        message.innerHTML = "No tasks exist.";
        message.classList.add("notasks");
        taskBoxes.appendChild(message);
      }

      document.querySelectorAll(".radioFinished").forEach(btn => {
        btn.addEventListener("click", utilities.markAsFinished);
      });
    }

    async function displayListTask(task, user) {
      let taskBoxTmpl = document.getElementById("taskBoxTmpl");
      let radioFinished = taskBoxTmpl.content.querySelector(
        "input[type=radio]"
      );
      radioFinished.name = "taskid-" + task.id;
      radioFinished.setAttribute("id", "taskid-" + task.id);
      if (task.finished) {
        radioFinished.checked = true;
        radioFinished.classList.add("checked");
      } else {
        radioFinished.checked = false;
        radioFinished.classList.remove("checked");
      }
      taskBoxTmpl.content.querySelector(".vl-task-title").innerHTML = task.name;

      let date = task.due_date;
      if (date) {
        date = date.split("T")[0];
        if (date < new Date().toISOString().split("T")[0] && !task.finished) {
          console.log(taskBoxTmpl.content);
          taskBoxTmpl.content
            .querySelector(".viewList-task")
            .classList.add("overdue");
        }
      } else {
        date = "No due date";
      }
      taskBoxTmpl.content.querySelector(".duedate").innerHTML = date;
      taskBoxTmpl.content.querySelector(".user").innerHTML = user;
      taskBoxTmpl.content.querySelector(".tag").innerHTML = task.tag
        ? task.tag
        : "No tag assigned";
      let taskBoxContent = taskBoxTmpl.content.cloneNode(true);
      let taskBoxContainer = document.querySelector("#taskBoxes");
      taskBoxContainer.appendChild(taskBoxContent);
    }

    function changeTagFilter(evt) {
      document.querySelector("input[value=tag]").checked = true;
      getTasks(document.querySelector("#tagDropdown").value);
    }

    function changeDateFilter(evt) {
      document.querySelector("input[value=date]").checked = true;
      getTasks("date/" + document.querySelector("#dateDropdown").value);
    }

    function activateFilter(evt) {
      console.log(evt.target.value);
      evt.target.value == "tag" ? changeTagFilter() : changeDateFilter();
    }

    function goBack() {
      redirectUser("showlists.html");
    }
  </script>
</html>
